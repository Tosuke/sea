# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  - master

pool:
  vmImage: "Ubuntu-16.04"

jobs:
  - job: BuildAndTest
    displayName: "build and test"
    steps:
      - script: |
          docker run --name postgres -e POSTGRES_PASSWORD=onlyfortesting -d postgres:10-alpine
        displayName: "Run PostgreSQL"
      - task: Docker@2
        displayName: "Build docker container"
        inputs:
          command: build
          repository: rinsuki/sea
          tags: latest
      - script: |
          docker run --rm --link postgres:postgres -e DATABASE_URL="postgres://postgres:onlyfortesting@postgres/postgres" rinsuki/sea yarn test
        displayName: "Run yarn test"
  - job: PushToDockerHub
    displayName: "Push to DockerHub"
    dependsOn: BuildAndTest
    condition: and(succeeded(), eq(Build.SourceBranch, "refs/heads/master"))
    steps:
      - task: Docker@2
        displayName: "Login to DockerHub"
        inputs:
          command: login
          containerRegistry: dockerHub
      - task: Docker@2
        displayName: "Push to DockerHub"
        inputs:
          command: push
          repository: rinsuki/sea
          tags: latest
          containerRegistry: dockerHub
      - task: Docker@2
        displayName: "Log-out from DockerHub"
        inputs:
          command: logout
          containerRegistry: dockerHub
